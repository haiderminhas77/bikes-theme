{% comment %}
    Renders variant picker

    Accepts:
    - block: {Object} Block object
    - product_form_id: {Variable}
	- product: {Object} Object from CMS (for featured product only)
	- usage: {String} String define usage type for this instance of variant picker
	- swiper_theshold {int} On main-product instances, integer to define threshold over which colour radios are hidden and 'Show More button is rendered'
	- position: {Variable} An integer generated by the page of the collection to which a given product belongs, used to generate a unique ID for variant pickers of quick add products when infinite scroll is active

    Usage:
    {% render 'product-variant-picker', block: block, product_form_id: product_form_id %} within sections/main-product.liquid
	{% render 'product-variant-picker', product: product, block: block, product_form_id: product_form_id %} within sections/featured-product.liquid
{% endcomment %}

{%- comment -%}Assign values for variant slection logic{%- endcomment -%}

{% assign colour_lang_string = 'products.product.color' | t %}

{%- comment -%}If product has variants, render required variant picker{%- endcomment -%}
{%- unless product.has_only_default_variant -%}
	
	{% case usage %}
	{% when "main-product" or "quick-view" %}
		{% if product.options.size > 1 %}
			{% assign current_variant_oos_option2s = '' %}

			{% capture current_variant_option2s %}{% for variant in product.variants %}{% if variant.option1 == product.selected_or_first_available_variant.option1 %}{{ variant.option2 }}{% if variant.available == false %}{% assign current_variant_oos_option2s = current_variant_oos_option2s | append: variant.option2 | append: ',' %}{% endif %}{% unless forloop.last %},{% endunless %}{% endif %}{% endfor %}{% endcapture %}

			{% assign current_variant_option2s_array = current_variant_option2s | split: ',' | uniq %}

			{% assign current_variant_oos_option2s_array = current_variant_oos_option2s | split: ',' | uniq %}
		{% endif %}

		{% capture fully_oos_options %}{% for option in product.options_with_values %}{% for option_value in option.values %}{% assign option_matches = 0 %}{% assign oos_option_matches = 0 %}{% for variant in product.variants %}{% for variant_option in variant.options %}{% if option_value == variant_option %}{% assign option_matches = option_matches | plus: 1 %}{% unless variant.available %}{% assign oos_option_matches = oos_option_matches | plus: 1 %}{% endunless %}{% endif %}{% endfor %}{% endfor %}{% if option_matches == oos_option_matches %}{{ option_value }},{% endif %}{% endfor %}{% endfor %}{% endcapture %}

		{% assign fully_oos_options_array = fully_oos_options | split: ',' | uniq %}

		<variant-picker
			class="no-js-hidden {% if block.settings.hide_variant_picker %}hidden{% endif %}"
			data-product-id="{{ product.id }}"
			data-section="{{ section.id }}"
			data-url="{{ product.url }}"
			data-colour-langstring="{{ 'products.product.color' | t }}"
			data-usage="{{ usage }}" {{ block.shopify_attributes }}>

			{%- for option in product.options_with_values -%}
				{% if option.name == "Color" or option.name == "Colour" %}
					{%- comment -%}FIELDSET / main-product / Colour. Style display: none; added below as colour variant picker is not needed (using sibling selector instead) {%- endcomment -%}
					<fieldset data-option="{{ option.name }}" data-product="{{ product.title }}" data-input="radio" id="{{ forloop.index }}" style="display: none;" class="js product-form__input {% if option.name == colour_lang_string %} product-form__input_color{% endif %}">
						<legend class="form__label">{{ option.name }}: <span class="form__label--value">{{ product.selected_or_first_available_variant.option1 }}</span></legend>

						{%- for value in option.values -%}
							{% unless swatch_count and forloop.index > swatch_count %}

								{% for variant in product.variants %}
									{% if option.name == colour_lang_string %}{% if variant.featured_media.alt contains value %}{% assign option_media = variant.featured_media %}{% endif %}{% endif %}
								{% endfor %}

								<input 
									type="radio"
									id="{{ section.id }}-{{ option.position }}-{{ forloop.index0 }}-{{ product.id }}"
									name="{{ option.name }}{% if product_card_index %}-{{ product_card_index }}{% endif %}"
									value="{{ value | escape }}" form="{{ product_form_id }}" data-option-index="{{ option.position }}" {% if option.selected_value == value %}checked{% endif %}
									class="product-form__variant-input{% if forloop.index > pdp_colour_thumbnails_threshold %} hidden{% endif %}"
								>
								<label
									for="{{ section.id }}-{{ option.position }}-{{ forloop.index0 }}-{{ product.id }}"
									class="{% if forloop.index > pdp-colour-thumbnails-threshold %}hidden {% endif %} product-form__thumbnail-label product-form__thumbnail-label--pdp{% for fully_oos_option in fully_oos_options_array %}{% if fully_oos_option == value %} product-form__option--unavailable{% endif %}{% endfor %}">
									{% comment %} {% render 'product-thumbnail-variants', media: option_media %} {% endcomment %}
								</label>

								{% if forloop.index == pdp_colour_thumbnails_threshold %}
									<div id="product-form__show-more-label" class="product-form__show-more-label product-form__thumbnail-label product-form__thumbnail-label--pdp"><p>{{ 'products.product.show' | t }}</p><p>{{ 'products.product.more' | t }}</p></div>
								{% endif %}

								{% if forloop.last and forloop.index > pdp_colour_thumbnails_threshold %}
									<div id="product-form__show-less-label" class="hidden product-form__show-more-label product-form__thumbnail-label product-form__thumbnail-label--pdp"><p>{{ 'products.product.show' | t }}</p><p>{{ 'products.product.less' | t }}</p></div>
								{% endif %}
							{% endunless %}
						{%- endfor -%}
					</fieldset>
				{% else %}
					{%- comment -%}FIELDSET / main-product / Size or Other{%- endcomment -%}
					<fieldset data-option="{{ option.name }}" data-product="{{ product.title }}" data-input="radio" id="{{ forloop.index }}"
						class="js product-form__input product-form__input_size">
						{%- for value in option.values -%}

						{% if product.options.size > 1 %}
							{% assign oos_value = false %}
							{% assign value_matches = 0 %}

							{% for current_variant_oos_option2 in current_variant_oos_option2s_array %}
								{% if value == current_variant_oos_option2 %}
									{% assign oos_value = true %}
								{% endif %}
							{% endfor %}

							{% for current_variant_option2 in current_variant_option2s_array %}
								{% if value == current_variant_option2 %}
									{% assign value_matches = value_matches | plus: 1 %}
								{% endif %}
							{% endfor %}
						{% else %}
							{% assign oos_value = false %}

							{% for fully_oos_option in fully_oos_options_array %}
								{% if fully_oos_option == value %}
									{% assign oos_value = true %}
								{% endif %}
							{% endfor %}
						{% endif %}

							<input
								type="radio" id="{{ section.id }}-{{ option.position }}-{{ forloop.index0 }}-{{ product.id }}"
								name="{{ option.name }}-{% if product_card_index %}-{{ product_card_index }}{% endif %}"
								value="{{ value | escape }}"
								form="{{ product_form_id }}"
								data-option-index="{{ option.position }}"
								{% if option.selected_value == value %}checked{% endif %}
								class="product-form__variant-input"
									>
							<label
								for="{{ section.id }}-{{ option.position }}-{{ forloop.index0 }}-{{ product.id }}"
								class="product-for__input--default{% if oos_value or value_matches == 0 %} product-form__option--unavailable{% endif %}"
								>{{ value }}</label>
						{% endfor %}
					</fieldset>
				{% endif %}
			{% endfor %}

			<script class="json__variants" type="application/json">
				{{ product.variants | json }}
			</script>
		</variant-picker>

	{% when "quick-add" %}

		{% if product.options.size > 1 %}
			{% assign current_variant_oos_option2s = '' %}

			{% capture current_variant_option2s %}{% for variant in product.variants %}{% if variant.option1 == product.selected_or_first_available_variant.option1 %}{{ variant.option2 }}{% if variant.available == false %}{% assign current_variant_oos_option2s = current_variant_oos_option2s | append: variant.option2 | append: ',' %}{% endif %}{% unless forloop.last %},{% endunless %}{% endif %}{% endfor %}{% endcapture %}

			{% assign current_variant_option2s_array = current_variant_option2s | split: ',' | uniq %}

			{% assign current_variant_oos_option2s_array = current_variant_oos_option2s | split: ',' | uniq %}
		{% endif %}

		{% capture fully_oos_options %}{% for option in product.options_with_values %}{% for option_value in option.values %}{% assign option_matches = 0 %}{% assign oos_option_matches = 0 %}{% for variant in product.variants %}{% for variant_option in variant.options %}{% if option_value == variant_option %}{% assign option_matches = option_matches | plus: 1 %}{% unless variant.available %}{% assign oos_option_matches = oos_option_matches | plus: 1 %}{% endunless %}{% endif %}{% endfor %}{% endfor %}{% if option_matches == oos_option_matches %}{{ option_value }},{% endif %}{% endfor %}{% endfor %}{% endcapture %}

		{% assign fully_oos_options_array = fully_oos_options | split: ',' | uniq %}

		<variant-picker
			class="no-js-hidden"
			data-product-id="{{ product.id }}"
			data-section="{{ section.id }}"
			data-url="{{ product.url }}"
			data-update-url="false"
			data-colour-langstring="{{ 'products.product.color' | t }}"
			data-usage="{{ usage }}" {{ block.shopify_attributes }}
		>

			{%- comment -%}Loop through products options (i.e colour, size etc) and render an certain input fieldset, depending on option type and snippet context{%- endcomment -%}
			{%- for option in product.options_with_values -%}
				{% if option.name == colour_lang_string %}
					{%- comment -%}FIELDSET / quick-add / Colour {%- endcomment -%}
					<fieldset data-option="{{ option.name }}" data-product="{{ product.title }}" data-input="radio" id="{{ forloop.index }}" class="js product-form__input product-form__input_color">

						{%- comment -%}Thumbnail slider start{%- endcomment -%}
						<slider-component class="thumbnail-slider">
							<ul id="Slider-{{ section.id }}" class="product-form__thumbnail-list thumbnail-list list-unstyled slider" role="list">
								{%- for value in option.values -%}

									{% for variant in product.variants %}
										{% if option.name == colour_lang_string %}{% if variant.featured_media.alt contains value %}{% assign option_media = variant.featured_media %}{% endif %}{% endif %}
									{% endfor %}

									<li id="Slide-{{ section.id }}-{{ forloop.index }}" class="thumbnail-list__item slider__slide">
										<input type="radio"
											id="{{ section.id }}-{{ option.position }}-{{ forloop.index0 }}-{{ product_card_index }}{{ position }}{% if feat_collection_index %}-{{ feat_collection_index }}{% endif %}{% if feat_variants_index %}-{{ feat_variants_index }}{% endif %}-{{ product.id }}"
											name="{{ option.name }}{% if product_card_index %}-{{ product_card_index }}{% endif %}{{ position }}{% if feat_collection_index %}-{{ feat_collection_index }}{% endif %}{% if feat_variants_index %}-{{ feat_variants_index }}{% endif %}"
											value="{{ value | escape }}" form="{{ product_form_id }}" data-option-index="{{ option.position }}" {% if option.selected_value == value %}checked{% endif %}
											class="product-form__variant-input">
										
										<label
											for="{{ section.id }}-{{ option.position }}-{{ forloop.index0 }}-{{ product_card_index }}{{ position }}{% if feat_collection_index %}-{{ feat_collection_index }}{% endif %}{% if feat_variants_index %}-{{ feat_variants_index }}{% endif %}-{{ product.id }}"
											class="product-form__thumbnail-label{% for fully_oos_option in fully_oos_options_array %}{% if fully_oos_option == value %} product-form__option--unavailable{% endif %}{% endfor %}">
											{% render 'product-thumbnail-variants', media: option_media %}
										</label>
									</li>
								{%- endfor -%}
							</ul>

							{% if option.values.size > swiper_threshold %}
								<div class="thumbnail__controls no-js-hidden">
									<div class="slider-buttons no-js-hidden">
										<button type="button" class="slider-button slider-button--prev" name="previous"
											aria-label="{{ 'general.slider.previous_slide' | t }}" aria-controls="Slider-{{ section.id }}">{% render
											'icon-caret' %}</button>
										<button type="button" class="slider-button slider-button--next" name="next"
											aria-label="{{ 'general.slider.next_slide' | t }}" aria-controls="Slider-{{ section.id }}">{% render
											'icon-caret' %}</button>
									</div>
								</div>
							{% endif %}
						</slider-component>
					</fieldset>

				{%- comment -%}The below piece of logic has been purposefully edited so that this condition will not execute, to avoid the size drop down selectors displaying for now{%- endcomment -%}
				{% elsif option.name == 'size_lang_string' %}

					{%- comment -%} FIELDSET / quick-add / size {%- endcomment -%}
					<fieldset data-option="{{ option.name }}" data-product="{{ product.title }}" data-input="option" id="{{ forloop.index }}" class="js product-form__input product-form__input_size_lang">
						<legend class="form__label">{{ option.name }}</legend>
						<select class="product-form__size-select" >
							{%- for value in option.values -%}
								<option id="{{ section.id }}-{{ option.position }}-{{ forloop.index0 }}{% if product_card_index %}-{{ product_card_index }}{% endif %}{{ position }}" name="{{ option.name }}{% if product_card_index %}-{{ product_card_index }}{% endif %}{% if quick_add %}{{ position }}{% endif %}" value="{{ value | escape }}" form="{{ product_form_id }}" data-option-index="{{ option.position }}" {% if option.selected_value == value %}selected{% endif %} class="product-form__variant-input product-form__variant-input--size{% if product.options.size == 1 %}{% for variant in product.variants %}{% for option in variant.options %}{% if option == value and variant.available == false %} product-form__option--unavailable{% endif %}{% endfor %}{% endfor %}{% elsif product.options.size > 1 %}{% for fully_oos_option in fully_oos_options_array %}{% if fully_oos_option == value %} product-form__option--unavailable{% endif %}{% endfor %}{% endif %}">{{ value }}</option>
							{%- endfor -%}
						</select>
					</fieldset>

				{% else %}
					{%- comment -%} FIELDSET / quick-add / other {%- endcomment -%}
					<fieldset data-option="{{ option.name }}" data-product="{{ product.title }}" data-input="radio" id="{{ forloop.index }}"
						class="js product-form__input product-form__input_size fieldset__text-radio">
						<legend class="form__label">
							{{ option.name }}{% if option.name == colour_lang_string %}: {{
							product.selected_or_first_available_variant.option1 }}
							{% endif %}
						</legend>
						{%- for value in option.values -%}
							{% if product.options.size > 1 %}
								{% assign oos_value = false %}
								{% assign value_matches = 0 %}

								{% for current_variant_oos_option2 in current_variant_oos_option2s_array %}
									{% if value == current_variant_oos_option2 %}
										{% assign oos_value = true %}
									{% endif %}
								{% endfor %}

								{% for current_variant_option2 in current_variant_option2s_array %}
									{% if value == current_variant_option2 %}
										{% assign value_matches = value_matches | plus: 1 %}
									{% endif %}
								{% endfor %}
							{% else %}
								{% assign oos_value = false %}

								{% for fully_oos_option in fully_oos_options_array %}
									{% if fully_oos_option == value %}
										{% assign oos_value = true %}
									{% endif %}
								{% endfor %}
							{% endif %}

							<input 
								type="radio" 
								id="{{ section.id }}-{{ option.position }}-{{ forloop.index0 }}{% if product_card_index %}-{{ product_card_index }}{% endif %}{% if quick_add %}{{ position }}{% endif %}-{{ product.id }}"
								name="{{ option.name }}{% if product_card_index %}-{{ product_card_index }}{% endif %}{% if quick_add %}{{ position }}{% endif %}"
								value="{{ value | escape }}"
								form="{{ product_form_id }}"
								data-option-index="{{ option.position }}"
								{% if option.selected_value == value %}checked{% endif %}
								class="product-form__variant-input"
									>
							<label 
								for="{{ section.id }}-{{ option.position }}-{{ forloop.index0 }}{% if product_card_index %}-{{ product_card_index }}{% endif %}{% if quick_add %}{{ position }}{% endif %}-{{ product.id }}"
								class="{% if oos_value or value_matches == 0 %} product-form__option--unavailable{% endif %}{% if option.name == colour_lang_string %} product-form__hex-label{% endif %}"{% if option.name == colour_lang_string %}
								style="background-color: {{ current_variant_hex }};"{% endif %}
								>{{ value }}</label>
						{% endfor %}
					</fieldset>
				{% endif %}
			{%- endfor -%}

			<script class="json__variants" type="application/json">
				{{ product.variants | json }}
			</script>
		</variant-picker>

		{% if product.options.size > 1 %}
			{% assign current_variant_oos_option2s = '' %}

			{% capture current_variant_option2s %}{% for variant in product.variants %}{% if variant.option1 == product.selected_or_first_available_variant.option1 %}{{ variant.option2 }}{% if variant.available == false %}{% assign current_variant_oos_option2s = current_variant_oos_option2s | append: variant.option2 | append: ',' %}{% endif %}{% unless forloop.last %},{% endunless %}{% endif %}{% endfor %}{% endcapture %}

			{% assign current_variant_option2s_array = current_variant_option2s | split: ',' | uniq %}

			{% assign current_variant_oos_option2s_array = current_variant_oos_option2s | split: ',' | uniq %}
		{% endif %}

		{% capture fully_oos_options %}{% for option in product.options_with_values %}{% for option_value in option.values %}{% assign option_matches = 0 %}{% assign oos_option_matches = 0 %}{% for variant in product.variants %}{% for variant_option in variant.options %}{% if option_value == variant_option %}{% assign option_matches = option_matches | plus: 1 %}{% unless variant.available %}{% assign oos_option_matches = oos_option_matches | plus: 1 %}{% endunless %}{% endif %}{% endfor %}{% endfor %}{% if option_matches == oos_option_matches %}{{ option_value }},{% endif %}{% endfor %}{% endfor %}{% endcapture %}

		{% assign fully_oos_options_array = fully_oos_options | split: ',' | uniq %}

		<variant-picker
			class="no-js-hidden"
			data-product-id="{{ product.id }}"
			data-section="{{ section.id }}"
			data-url="{{ product.url }}"
			data-update-url="false"
			data-colour-langstring="{{ 'products.product.color' | t }}"
			data-usage="{{ usage }}" {{ block.shopify_attributes }}>

		{%- comment -%}Loop through products options (i.e colour, size etc) and render an certain input fieldset, depending on option type and snippet context{%- endcomment -%}
			{%- for option in product.options_with_values -%}
				{% if option.name == colour_lang_string %}
					{%- comment -%} Option type is Colour - render thumbnail radio buttons in basic slideshow component {%- endcomment -%}

					<fieldset data-option="{{ option.name }}" data-product="{{ product.title }}" data-input="radio" id="{{ forloop.index }}" class="js product-form__input">

						<legend class="form__label">
							{{ option.name }}{% if option.name == colour_lang_string %}: {{ product.selected_or_first_available_variant.option1 }}
							{% endif %}
						</legend>

						{%- comment -%}Thumbnail slider start{%- endcomment -%}
						<slider-component class="thumbnail-slider">
							<ul id="Slider-{{ section.id }}" class="product-form__thumbnail-list thumbnail-list list-unstyled slider" role="list">
								{%- for value in option.values -%}

									{% for variant in product.variants %}
										{% if option.name == colour_lang_string %}{% if variant.featured_media.alt contains value %}{% assign option_media = variant.featured_media %}{% endif %}{% endif %}
									{% endfor %}

									<li id="Slide-{{ section.id }}-{{ forloop.index }}" class="thumbnail-list__item slider__slide">
										<input type="radio"
											id="{{ section.id }}-{{ option.position }}-{{ forloop.index0 }}-{{ product.id }}"
											name="{{ option.name }}"
											value="{{ value | escape }}" form="{{ product_form_id }}" data-option-index="{{ option.position }}" {% if option.selected_value == value %}checked{% endif %}
											class="product-form__variant-input">
										<label
										for="{{ section.id }}-{{ option.position }}-{{ forloop.index0 }}-{{ product.id }}"
										class="product-form__thumbnail-label{% comment %} Following liquid/class are for availability handling only {% endcomment %}{% for fully_oos_option in fully_oos_options_array %}{% if fully_oos_option == value %} product-form__option--unavailable{% endif %}{% endfor %}">
											{% render 'product-thumbnail-variants', media: option_media %}
										</label>
									</li>
								{%- endfor -%}
							</ul>

							<div class="thumbnail__controls no-js-hidden">
								<div class="slider-buttons no-js-hidden">
									<button type="button" class="slider-button slider-button--prev" name="previous"
										aria-label="{{ 'general.slider.previous_slide' | t }}" aria-controls="Slider-{{ section.id }}" data-parent="slider-component">{% render
										'icon-caret' %}</button>
									<button type="button" class="slider-button slider-button--next" name="next"
										aria-label="{{ 'general.slider.next_slide' | t }}" aria-controls="Slider-{{ section.id }}" data-parent="slider-component">{% render
										'icon-caret' %}</button>
								</div>
							</div>
						</slider-component>
					</fieldset>
				{% else %}
					<fieldset data-option="{{ option.name }}" data-product="{{ product.title }}" data-input="radio" id="{{ forloop.index }}"
						class="js product-form__input product-form__input_size">
						<legend class="form__label"><p>{{ option.name }}:</p><p>{{ option.size }}</p></legend>
							{%- for value in option.values -%}
								{% if product.options.size > 1 %}
									{% assign oos_value = false %}
									{% assign value_matches = 0 %}

									{% for current_variant_oos_option2 in current_variant_oos_option2s_array %}
										{% if value == current_variant_oos_option2 %}
											{% assign oos_value = true %}
										{% endif %}
									{% endfor %}

									{% for current_variant_option2 in current_variant_option2s_array %}
										{% if value == current_variant_option2 %}
											{% assign value_matches = value_matches | plus: 1 %}
										{% endif %}
									{% endfor %}
								{% else %}
									{% assign oos_value = false %}

									{% for fully_oos_option in fully_oos_options_array %}
										{% if fully_oos_option == value %}
											{% assign oos_value = true %}
										{% endif %}
									{% endfor %}
								{% endif %}

							<input
								type="radio" id="{{ section.id }}-{{ option.position }}-{{ forloop.index0 }}-{{ product.id }}"
								name="{{ option.name }}{% if product_card_index %}-{{ product_card_index }}{% endif %}"
								value="{{ value | escape }}"
								form="{{ product_form_id }}"
								data-option-index="{{ option.position }}"
								{% if option.selected_value == value %}checked{% endif %}
								class="product-form__variant-input"
									>
							<label
								for="{{ section.id }}-{{ option.position }}-{{ forloop.index0 }}-{{ product.id }}"
								class="product-for__input--default{% if oos_value or value_matches == 0 %} product-form__option--unavailable{% endif %}"
								>{{ value }}</label>
						{% endfor %}
					</fieldset>
				{% endif %}
			{%- endfor -%}

			<script class="json__variants" type="application/json">
				{{ product.variants | json }}
			</script>
		</variant-picker>
	{% endcase %}
{% endunless %}

<noscript class="product-form__noscript-wrapper-{{ section.id }}">
	<div class="product-form__input{% if product.has_only_default_variant %} hidden{% endif %}">
		<label class="form__label" for="Variants-{{ section.id }}">{{ 'products.product.product_variants' | t }}</label>
		<div class="select">
			<select name="id" id="Variants-{{ section.id }}" class="select__select" form="{{ product_form_id }}">
				{%- for variant in product.variants -%}
				<option {% if variant == product.selected_or_first_available_variant %}selected="selected" {% endif %} {%
					if variant.available == false %}disabled{% endif %} value="{{ variant.id }}">
					{{ variant.title }}
					{%- if variant.available == false %} - {{ 'products.product.oos' | t }}{% endif %}
					- {{ variant.price | money | strip_html }}
				</option>
				{%- endfor -%}
			</select>
			{% render 'icon-caret' %}
		</div>
	</div>
</noscript>